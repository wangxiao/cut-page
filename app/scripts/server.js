void function() {

    var appId = '7f69g7feabv7lts11vtjlu13q5ngrtab0hs426535nh2eotl';
    var appKey = 'plvj3ewitm5k3wamysd593tp2l9f61bp6o4ma6vtxp9j7h5y';
    var roomId = '55571ad2e4b032516125f0e4';
    var maps = [
        {"edges":6,"base":{"center":[250,450],"radius":400},"polygon":[[226.90755248313798,363.8178125959531],[188.88243068771772,221.90612609144992],[202,201],[218,177],[228,163],[221,157],[214,150],[201,142],[187,131],[159.9457957029362,113.91313412817023],[146.47238195899175,63.6296694843727],[188.14354342773294,63.6296694843727],[189,65],[197,73],[199,74],[200,76],[201,77],[202,77],[202,78],[203,78],[206,82],[208,88],[212,95],[218,107],[223,120],[227,132],[232,145],[237,156],[240,174],[245,193],[249,231],[252,247],[253,258],[254,262],[254,265],[255,265],[256,250],[259,234],[264,212],[271,186],[287,139],[302,99],[316,66],[316.6772372901792,63.6296694843727],[353.5276180410084,63.6296694843727],[270.30185511382126,374.2324452273171]]},
        {"edges":6,"base":{"center":[250,450],"radius":400},"polygon":[[274.62533665769763,358.09699243998415],[323.745389150445,174.77846086660074],[302,178],[278,180],[260,184],[248,181],[246,179],[237,163],[229,152],[216,128],[208,117],[204,109],[202,104],[198,99],[199,99],[201,100],[209,100],[212,101],[220,101],[225,102],[343.2463189660308,102],[353.5276180410084,63.6296694843727],[146.47238195899175,63.6296694843727],[190.3366556628161,227.33336758415274],[255,228],[257,228],[260,229],[263,229],[266,230],[265,237],[255,260],[242,292],[219.99339240290084,338.01381588484367],[233.12310138043048,387.01455687757755],[244,379]]},
        {"edges":6,"base":{"center":[250,450],"radius":400},"polygon":[[326.0975706504389,166],[335.7437415779593,130],[324,130],[318,131],[313,131],[308,132],[281,132],[269,134],[241,134],[229,135],[223,136],[200,137],[200,138],[199,139],[199,129],[198,116],[197,116],[197,108],[195,99],[195,94],[194,94],[194,93],[193,93],[310,92],[320,91],[346.1937600827731,91],[353.5276180410084,63.6296694843727],[146.47238195899175,63.6296694843727],[250,450],[316.98150822881286,200.02160812247772],[300,198],[289,196],[270,194],[270,197],[269,200],[269,204],[268,206],[268,224],[267,231],[267,236],[265,244],[265,253],[264,264],[260,291],[258,312],[256,322],[255,331],[255,342],[254,347],[254,349],[253,349],[252,348],[249,329],[249,309],[248,306],[247,300],[242,283],[227,211],[225,192],[222,178],[218,165],[217,164],[217,163],[223,163],[226,164],[232,165],[240,165],[248,166]]},
        {"edges":6,"base":{"center":[250,450],"radius":400},"polygon":[[161.95731431980175,121.42022380668318],[193.360959734862,238.62022403856554],[232,233],[273,230],[281,230],[281,231],[278,237],[276,246],[271,255],[269,267],[266,275],[264,288],[263,290],[260,300],[256,306],[253,313],[251,315],[251,314],[250,314],[250,313],[249,313],[236,307],[235,307],[232,285],[230,279],[230,274],[228,267],[228,264],[218,264],[200.52170369850785,265.34448433088403],[250,450],[353.5276180410084,63.6296694843727],[146.47238195899175,63.6296694843727],[155.01793338433447,95.52210158244434],[171,94],[183,94],[226,92],[260,92],[290,94],[298,94],[304,95],[311,95],[311,96],[310,96],[308,99],[302,105],[296,113],[277,136],[262,156],[255,164],[246,177],[237,188],[236,190],[236,192],[235,192],[235,189],[234,189],[234,188],[233,188],[231,187],[230,186],[228,181],[227,180],[226,178],[225,178],[225,177],[211,177],[199,174],[198,173],[196,158],[197,149],[197,139],[198,132],[167,121]]},
        {"edges":6,"base":{"center":[250,450],"radius":400},"polygon":[[165.12876666643632,133.25624509810697],[187.58848453935832,217.07705332351466],[198,216],[213,216],[225,215],[279,215],[278,221],[270,241],[260,259],[250,283],[236,319],[227,349],[225.44196955752398,358.3481826548562],[250,450],[353.5276180410084,63.6296694843727],[146.47238195899175,63.6296694843727],[158.6293253809872,109],[167,109],[207,106],[224,104],[254,102],[291,102],[295,103],[301,103],[300,105],[297,108],[293,113],[289,120],[285,125],[278,138],[277,142],[274,150],[268,162],[267,166],[266,166],[264,171],[262,176],[262,178],[254,178],[248,179],[243,179],[237,180],[229,180],[219,182],[214,182],[211,183],[209,183],[207,184],[206,184],[206,183],[205,183],[205,181],[201,158],[201,146],[200,137],[199,132],[199,129],[198,126],[198,123],[196,123],[195,124],[190,125],[183,128]]}
    ];

    AV.initialize(appId, appKey);

    window.player = function() {

        // 用户数据
        var attr = {
            name: '',
            score: []
        };

        var eventCenter = $({});
        var room;

        // 游戏状态  0 准备开始 1 正在玩 2 准备结束
        var status = 0;

        var otherData = {};
        var map = maps[Math.floor(Math.random() * (maps.length - 1))];

        function isEnd(myData, otherData) {
            if (status === 2) {
                eventCenter.trigger('end', {
                    results: [
                        myData, 
                        otherData
                    ]
                });
                status = 0;
            }
        }

        function isStart(otherData) {
            if (status === 0) {
                eventCenter.trigger('start', {
                    maps:  otherData.maps,
                    user: otherData.user
                });
                status = 1;
            }
        }

        return {
            attr: attr,
            login: function(name, callback) {
                var me = this;
                me.attr.name = name;

                // 创建实时通信实例
                var rt = AV.realtime({
                    appId: appId,
                    clientId: name,
                    secure: false
                });
                rt.on('open', function() {
                    rt.room(roomId, function(obj) {
                        if (obj) {
                            room = obj;
                            room.join();
                            room.send({
                                status: 'online',
                                user: attr
                            }, function() {
                                callback && callback();
                            });

                            rt.on('message', function(data) {
                                otherData = data.msg.user;
                                switch(data.msg.status) {
                                    case 'online':
                                        room.send({
                                            status: 'start',
                                            user: attr,
                                            maps: map
                                        });
                                        var obj = {
                                            user: data.msg.user,
                                            maps: map
                                        };
                                        isStart(obj);
                                    break;
                                    case 'start':
                                        isStart(data.msg);
                                    break;
                                    case 'end':
                                        isEnd(me.attr, otherData);
                                        status = 2;
                                    break;
                                }
                            });                            
                        } else {
                            alert('服务器的聊天数据被删！');
                        }
                    });
                });
                return this;
            },
            end: function(myData) {
                var me = this;
                isEnd(me.attr, otherData);
                status = 2;
                for (var k in myData) {
                    me.attr[k] = myData[k];
                }
                room.send({
                    status: 'end',
                    user: me.attr
                });
                return this;
            },
            on: function(eventName, fun) {
                eventCenter.on(eventName, fun);
                return this;
            }
        };
    };
}();

// var p = window.player();

// // 登录游戏，准备开始
// p.login('2222', function() {
//     console.log('123');
// });

// // 监听是否开始游戏
// p.on('start', function(event, data) {
//     console.log('start', data);
// });

// // 监听游戏是否结束
// p.on('end', function(event, data) {
//     console.log('end', data);
// });

// // 告知对方当前客户端已经结束游戏
// p.end({
//     // 每个的相似度等
//     score: [30, 20, 30]
// });

